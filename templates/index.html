<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Radarr Toolbox</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        h1 {
            text-align: center;
            padding: 15px 0;
            background: #2a2a2a;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            background: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #888;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #333;
            color: #e0e0e0;
        }

        .tab.active {
            background: #4CAF50;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #4CAF50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            margin-bottom: 10px;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        button.secondary {
            background: #2196F3;
        }

        button.secondary:hover {
            background: #0b7dda;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover {
            background: #da190b;
        }

        button.warning {
            background: #FF9800;
        }

        button.warning:hover {
            background: #e68900;
        }

        .movie-item, .queue-item {
            background: #333;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .movie-info, .queue-info {
            flex: 1;
            min-width: 200px;
        }

        .movie-title, .queue-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .movie-details, .queue-details {
            font-size: 0.9em;
            color: #aaa;
        }

        .movie-actions, .queue-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            width: 100%;
        }

        .movie-actions button, .queue-actions button {
            flex: 1;
            margin: 0;
        }

        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
        }

        .status.pending {
            background: #FFA726;
            color: #000;
        }

        .status.copying, .status.processing {
            background: #42A5F5;
            color: #fff;
        }

        .status.verifying {
            background: #AB47BC;
            color: #fff;
        }

        .status.updating {
            background: #26C6DA;
            color: #000;
        }

        .status.completed {
            background: #66BB6A;
            color: #000;
        }

        .status.failed {
            background: #EF5350;
            color: #fff;
        }

        .operation-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 8px;
        }

        .operation-badge.copy {
            background: #2196F3;
            color: white;
        }

        .operation-badge.convert {
            background: #FF9800;
            color: white;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge.success {
            background: #66BB6A;
            color: white;
        }

        .badge.warning {
            background: #FFA726;
            color: white;
        }

        .badge.info {
            background: #42A5F5;
            color: white;
        }

        .series-item {
            background: #333;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .series-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .series-title {
            font-weight: bold;
            font-size: 1.1em;
        }

        .series-details {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 5px;
        }

        .series-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .series-actions button {
            flex: 1;
            margin: 0;
        }

        .seasons-container {
            display: none;
            margin-top: 15px;
            padding-left: 15px;
            border-left: 3px solid #4CAF50;
        }

        .seasons-container.expanded {
            display: block;
        }

        .season-item {
            background: #2a2a2a;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .season-info {
            flex: 1;
            min-width: 200px;
        }

        .season-title {
            font-weight: bold;
        }

        .season-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .season-actions button {
            padding: 5px 10px;
            font-size: 0.85em;
        }

        .info-icon {
            cursor: pointer;
            background: #42A5F5;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            margin-left: 5px;
        }

        .verification-progress {
            background: #2a2a2a;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 2px solid #4CAF50;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #66BB6A);
            transition: width 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        input, select {
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #1a1a1a;
            color: #e0e0e0;
            font-size: 1em;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .error {
            background: #f44336;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .success {
            background: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .progress-text {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 5px;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 900px;
                padding: 20px;
            }

            .movie-actions, .queue-actions {
                width: auto;
                margin-top: 0;
            }

            .movie-actions button, .queue-actions button {
                width: auto;
                flex: 0;
            }
        }
    </style>
</head>
<body>
    <h1>üé¨ Ultimate Radarr Toolbox</h1>
    
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('safe-copy')">üì¶ Safe Copy</button>
            <button class="tab" onclick="switchTab('dts-converter')">üéµ DTS Converter</button>
            <button class="tab" onclick="switchTab('media-integrity')">üîç Media Integrity</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <!-- Safe Copy Tab -->
        <div id="safe-copy" class="tab-content active">
            <!-- Movies Section -->
            <div class="section">
                <div class="section-title">
                    <span>üìÅ Movies on SSD</span>
                    <button onclick="refreshMovies()" style="width: auto; margin: 0; padding: 8px 15px;">üîÑ Refresh</button>
                </div>
                <div id="movies-container">
                    <div class="loading">Loading movies...</div>
                </div>
            </div>

            <!-- Leftovers Section -->
            <div class="section">
                <div class="section-title">
                    <span>üóëÔ∏è Leftover Files</span>
                    <button onclick="refreshLeftovers()" style="width: auto; margin: 0; padding: 8px 15px;">üîÑ Refresh</button>
                </div>
                <div id="leftovers-container">
                    <div class="empty-state">Click Refresh to scan for leftover files</div>
                </div>
            </div>
        </div>

        <!-- Media Integrity Tab -->
        <div id="media-integrity" class="tab-content">
            <!-- Configuration Section -->
            <div class="section">
                <div class="section-title">
                    <span>‚öôÔ∏è Configuration</span>
                </div>
                <div class="form-group">
                    <label>Watch Directories (one per line):</label>
                    <textarea id="integrity-directories" rows="3" style="padding: 10px; border: 1px solid #444; border-radius: 5px; background: #1a1a1a; color: #e0e0e0; font-size: 1em; font-family: monospace; resize: vertical;"></textarea>
                </div>
                <div class="form-group">
                    <label>Test Directory (optional, for testing):</label>
                    <input type="text" id="integrity-test-directory" placeholder="/path/to/test/dir">
                </div>
                <button onclick="saveIntegrityConfig()" class="secondary">üíæ Save Configuration</button>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="resetIntegrityData()" class="danger" style="flex: 1;">üóëÔ∏è Reset All Data</button>
                    <button onclick="clearIntegrityReports()" class="warning" style="flex: 1;">üßπ Clear Reports</button>
                    <button onclick="resetBrokenFiles()" class="warning" style="flex: 1;">üîÑ Reset Broken</button>
                </div>
            </div>

            <!-- Statistics Section -->
            <div class="section">
                <div class="section-title">
                    <span>üìä Statistics</span>
                    <button onclick="refreshIntegrityStats()" style="width: auto; margin: 0; padding: 8px 15px;">üîÑ Refresh</button>
                </div>
                <div id="integrity-stats-container">
                    <div class="empty-state">Click Refresh to load statistics</div>
                </div>
            </div>

            <!-- Pass 1: Scan Section -->
            <div class="section">
                <div class="section-title">
                    <span>üîÑ Pass 1: Scan (Fast Index)</span>
                </div>
                <div id="scan-status-container">
                    <div class="empty-state">Not started</div>
                </div>
                <button onclick="startScan()" id="scan-start-btn">‚ñ∂Ô∏è Start Scan</button>
                <button onclick="stopScan()" id="scan-stop-btn" style="display: none;" class="danger">‚è∏Ô∏è Stop Scan</button>
            </div>

            <!-- Pass 2: Verify Section -->
            <div class="section">
                <div class="section-title">
                    <span>‚úì Pass 2: Verify (ffprobe + checksums)</span>
                </div>
                <div id="verify-status-container">
                    <div class="empty-state">Not started</div>
                </div>
                <button onclick="startVerify()" id="verify-start-btn">‚ñ∂Ô∏è Start Verify</button>
                <button onclick="stopVerify()" id="verify-stop-btn" style="display: none;" class="danger">‚è∏Ô∏è Stop Verify</button>
                <button onclick="resumeVerify()" id="verify-resume-btn" style="display: none;" class="secondary">‚ñ∂Ô∏è Resume from First Incomplete</button>
            </div>

            <!-- Pass 3: Recheck Section -->
            <div class="section">
                <div class="section-title">
                    <span>üîÅ Pass 3: Recheck (verify checksums)</span>
                </div>
                <div id="recheck-status-container">
                    <div class="empty-state">Not started</div>
                </div>
                <button onclick="startRecheck()" id="recheck-start-btn">‚ñ∂Ô∏è Start Recheck</button>
                <button onclick="stopRecheck()" id="recheck-stop-btn" style="display: none;" class="danger">‚è∏Ô∏è Stop Recheck</button>
            </div>

            <!-- Issues Section -->
            <div class="section">
                <div class="section-title">
                    <span>‚ö†Ô∏è Issues</span>
                    <button onclick="refreshIntegrityIssues()" style="width: auto; margin: 0; padding: 8px 15px;">üîÑ Refresh</button>
                </div>
                <div id="integrity-issues-container">
                    <div class="empty-state">No issues found</div>
                </div>
            </div>
        </div>

        <!-- DTS Converter Tab -->
        <div id="dts-converter" class="tab-content">
            <!-- DTS Movies Section -->
            <div class="section">
                <div class="section-title">
                    <span>üéµ Movies with DTS Audio</span>
                    <button onclick="refreshDTSMovies()" style="width: auto; margin: 0; padding: 8px 15px;">üîÑ Refresh</button>
                </div>
                <div id="dts-movies-container">
                    <div class="loading">Loading DTS movies...</div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="section">
                <div class="section-title">
                    <span>‚öôÔ∏è Radarr Configuration</span>
                </div>
                <div id="settings-message"></div>
                <form class="settings-form" onsubmit="saveSettings(event)">
                    <div class="form-group">
                        <label>Radarr Host:</label>
                        <input type="text" id="radarr_host" placeholder="192.168.1.100" required>
                    </div>
                    <div class="form-group">
                        <label>Radarr Port:</label>
                        <input type="text" id="radarr_port" placeholder="7878" required>
                    </div>
                    <div class="form-group">
                        <label>Radarr API Key:</label>
                        <input type="text" id="radarr_api_key" placeholder="your-api-key" required>
                    </div>
                    <div class="form-group" id="ssd-folder-group" style="display: none;">
                        <label>SSD Root Folder (auto-detected):</label>
                        <input type="text" id="ssd_root_folder" readonly style="background: #2a2a2a; cursor: not-allowed;">
                    </div>
                    <div class="form-group" id="hdd-folder-group" style="display: none;">
                        <label>HDD Root Folder (auto-detected):</label>
                        <input type="text" id="hdd_root_folder" readonly style="background: #2a2a2a; cursor: not-allowed;">
                    </div>
                    <button type="submit">üíæ Save Settings</button>
                </form>
            </div>
        </div>

        <!-- Unified Queue Section (shown on all tabs) -->
        <div class="section">
            <div class="section-title">
                <span>üìã Unified Operation Queue</span>
            </div>
            <div id="queue-container">
                <div class="empty-state">No items in queue</div>
            </div>
        </div>

        <!-- Unified History Section (shown on all tabs) -->
        <div class="section">
            <div class="section-title">
                <span>üìú Recent Operations</span>
            </div>
            <div id="history-container">
                <div class="empty-state">No operations yet</div>
            </div>
        </div>

        <!-- Emergency Controls Section -->
        <div class="section">
            <div class="section-title">
                <span>üö® Emergency Controls</span>
            </div>
            <button onclick="clearQueue()" class="danger">
                üóëÔ∏è Force Clear Queue
            </button>
            <p style="font-size: 0.85em; color: #888; margin-top: 10px; text-align: center;">
                Use this to forcefully clear all items from the unified queue, including currently processing items.
            </p>
        </div>
    </div>

    <script>
        let movies = [];
        let dtsMovies = [];
        let queue = [];
        let history = [];
        let leftovers = [];

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Don't auto-load data - user must click Refresh button
        }

        // ============================================================================
        // SAFE COPY TAB FUNCTIONS
        // ============================================================================

        // Refresh movies list
        async function refreshMovies() {
            const container = document.getElementById('movies-container');
            container.innerHTML = '<div class="loading">Loading movies...</div>';
            
            try {
                const response = await fetch('/api/movies');
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to load movies');
                }
                
                movies = await response.json();
                renderMovies();
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Render movies list
        function renderMovies() {
            const container = document.getElementById('movies-container');
            
            if (movies.length === 0) {
                container.innerHTML = '<div class="empty-state">No movies found on SSD</div>';
                return;
            }
            
            container.innerHTML = movies.map(movie => {
                const movieFile = movie.movieFile || {};
                const size = movieFile.size ? (movieFile.size / 1024 / 1024 / 1024).toFixed(2) + ' GB' : 'Unknown';
                const quality = movieFile.quality?.quality?.name || 'Unknown';
                
                const inQueue = queue.some(item => item.movie.id === movie.id);
                
                return `
                    <div class="movie-item">
                        <div class="movie-info">
                            <div class="movie-title">${movie.title} (${movie.year})</div>
                            <div class="movie-details">
                                üì¶ ${size} | üé• ${quality}
                            </div>
                        </div>
                        <div class="movie-actions">
                            <button 
                                onclick="addToQueue(${movie.id}, 'copy')" 
                                ${inQueue ? 'disabled' : ''}
                                class="secondary"
                            >
                                ${inQueue ? '‚úì In Queue' : '‚ûï Add to Queue'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Refresh leftovers list
        async function refreshLeftovers() {
            const container = document.getElementById('leftovers-container');
            container.innerHTML = '<div class="loading">Scanning for leftover files...</div>';
            
            try {
                const response = await fetch('/api/leftovers');
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to load leftovers');
                }
                
                leftovers = await response.json();
                renderLeftovers();
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Render leftovers list
        function renderLeftovers() {
            const container = document.getElementById('leftovers-container');
            
            if (leftovers.length === 0) {
                container.innerHTML = '<div class="empty-state">No leftover files found</div>';
                return;
            }
            
            container.innerHTML = leftovers.map(leftover => {
                const size = (leftover.size / 1024 / 1024 / 1024).toFixed(2) + ' GB';
                const fileCount = leftover.file_count;
                
                let buttons = '';
                if (leftover.can_recopy) {
                    buttons = `
                        <button
                            onclick="recopyLeftover(${leftover.movie_id}, '${leftover.name.replace(/'/g, "\\'")}', '${leftover.path.replace(/'/g, "\\'")}' )"
                            class="secondary"
                            style="flex: 1;"
                        >
                            üîÑ Re-copy
                        </button>
                        <button
                            onclick="deleteLeftover('${leftover.path.replace(/'/g, "\\'")}', '${leftover.name.replace(/'/g, "\\'")}')"
                            class="danger"
                            style="flex: 1;"
                        >
                            üóëÔ∏è Delete
                        </button>
                    `;
                } else {
                    buttons = `
                        <button
                            onclick="deleteLeftover('${leftover.path.replace(/'/g, "\\'")}', '${leftover.name.replace(/'/g, "\\'")}')"
                            class="danger"
                        >
                            üóëÔ∏è Delete
                        </button>
                    `;
                }
                
                return `
                    <div class="movie-item">
                        <div class="movie-info">
                            <div class="movie-title">${leftover.name}</div>
                            <div class="movie-details">
                                üì¶ ${size} | üìÑ ${fileCount} file${fileCount !== 1 ? 's' : ''}
                                ${leftover.can_recopy ? ' | ‚ö†Ô∏è Missing on HDD' : ''}
                            </div>
                            <div class="movie-details" style="font-size: 0.75em; color: #888; margin-top: 3px;">
                                ${leftover.path}
                            </div>
                        </div>
                        <div class="movie-actions">
                            ${buttons}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Re-copy leftover to queue
        async function recopyLeftover(movieId, name, ssdPath) {
            if (!confirm(`Re-copy "${name}" from SSD to HDD?\n\nThis will add the movie to the copy queue.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/leftovers/recopy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        movie_id: movieId,
                        ssd_path: ssdPath
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add to queue');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                await refreshQueue();
                await refreshLeftovers();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Delete leftover with confirmation
        async function deleteLeftover(path, name) {
            if (!confirm(`Are you sure you want to delete "${name}" and all its contents?\n\nThis action cannot be undone!`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/leftovers', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete leftover');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                await refreshLeftovers();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // ============================================================================
        // DTS CONVERTER TAB FUNCTIONS
        // ============================================================================

        // Refresh DTS movies list
        async function refreshDTSMovies() {
            const container = document.getElementById('dts-movies-container');
            container.innerHTML = '<div class="loading">Loading DTS movies...</div>';
            
            try {
                const response = await fetch('/api/movies/dts');
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to load DTS movies');
                }
                
                dtsMovies = await response.json();
                renderDTSMovies();
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Render DTS movies list
        function renderDTSMovies() {
            const container = document.getElementById('dts-movies-container');
            
            if (dtsMovies.length === 0) {
                container.innerHTML = '<div class="empty-state">No movies with DTS audio found</div>';
                return;
            }
            
            container.innerHTML = dtsMovies.map(movie => {
                const movieFile = movie.movieFile || {};
                const size = movieFile.size ? (movieFile.size / 1024 / 1024 / 1024).toFixed(2) + ' GB' : 'Unknown';
                const quality = movieFile.quality?.quality?.name || 'Unknown';
                const relativePath = movieFile.relativePath || '';
                
                const inQueue = queue.some(item => item.movie.id === movie.id);
                
                return `
                    <div class="movie-item">
                        <div class="movie-info">
                            <div class="movie-title">${movie.title} (${movie.year})</div>
                            <div class="movie-details">
                                üì¶ ${size} | üé• ${quality}
                            </div>
                            <div class="movie-details" style="font-size: 0.75em; color: #888; margin-top: 3px;">
                                ${relativePath}
                            </div>
                        </div>
                        <div class="movie-actions">
                            <button 
                                onclick="addToQueue(${movie.id}, 'convert')" 
                                ${inQueue ? 'disabled' : ''}
                                class="warning"
                            >
                                ${inQueue ? '‚úì In Queue' : 'üéµ Convert to FLAC'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================================================
        // UNIFIED QUEUE FUNCTIONS
        // ============================================================================

        // Add movie to unified queue
        async function addToQueue(movieId, operationType) {
            const movieList = operationType === 'copy' ? movies : dtsMovies;
            const movie = movieList.find(m => m.id === movieId);
            if (!movie) return;
            
            try {
                // For convert operation, show audio info confirmation
                if (operationType === 'convert') {
                    // Get audio info first
                    const audioResponse = await fetch(`/api/movies/${movieId}/audio-info`);
                    if (!audioResponse.ok) {
                        const error = await audioResponse.json();
                        throw new Error(error.error || 'Failed to get audio info');
                    }
                    
                    const audioInfo = await audioResponse.json();
                    
                    // Show confirmation with audio details
                    const confirmMessage = `Convert "${movie.title}" to FLAC 7.1?\n\n` +
                        `Current Audio:\n` +
                        `Codec: ${audioInfo.codec_long_name || audioInfo.codec_name}\n` +
                        `Channels: ${audioInfo.channel_layout} (${audioInfo.channels} channels)\n` +
                        `Sample Rate: ${audioInfo.sample_rate} Hz\n` +
                        `Bit Rate: ${audioInfo.bit_rate ? (parseInt(audioInfo.bit_rate) / 1000).toFixed(0) + ' kbps' : 'Unknown'}\n\n` +
                        `This will convert to FLAC 7.1 and replace the original file.`;
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                }
                
                const response = await fetch('/api/queue/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        movie: movie,
                        operation_type: operationType
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add to queue');
                }
                
                await refreshQueue();
                if (operationType === 'copy') {
                    renderMovies();
                } else {
                    renderDTSMovies();
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Refresh unified queue
        async function refreshQueue() {
            try {
                const response = await fetch('/api/queue');
                queue = await response.json();
                renderQueue();
            } catch (error) {
                console.error('Error refreshing queue:', error);
            }
        }

        // Render unified queue
        function renderQueue() {
            const container = document.getElementById('queue-container');
            
            if (queue.length === 0) {
                container.innerHTML = '<div class="empty-state">No items in queue</div>';
                return;
            }
            
            container.innerHTML = queue.map(item => {
                const movie = item.movie;
                const movieFile = movie.movieFile || {};
                const size = movieFile.size ? (movieFile.size / 1024 / 1024 / 1024).toFixed(2) + ' GB' : 'Unknown';
                const operationType = item.operation_type || 'unknown';
                const operationLabel = operationType === 'copy' ? 'Copy' : operationType === 'convert' ? 'Convert' : operationType;
                
                return `
                    <div class="queue-item">
                        <div class="queue-info">
                            <div class="queue-title">
                                ${movie.title} (${movie.year})
                                <span class="operation-badge ${operationType}">${operationLabel}</span>
                            </div>
                            <div class="queue-details">üì¶ ${size}</div>
                            <div class="status ${item.status}">${item.status.toUpperCase()}</div>
                            <div class="progress-text">${item.progress}</div>
                        </div>
                        <div class="queue-actions">
                            ${item.status === 'pending' ? `
                                <button onclick="removeFromQueue('${item.id}')" class="danger">
                                    üóëÔ∏è Remove
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Remove from unified queue
        async function removeFromQueue(itemId) {
            try {
                const response = await fetch(`/api/queue/${itemId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to remove from queue');
                }
                
                await refreshQueue();
                renderMovies();
                renderDTSMovies();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Force clear unified queue
        async function clearQueue() {
            if (!confirm('‚ö†Ô∏è WARNING: This will forcefully clear ALL items from the unified queue, including any currently processing items.\n\nThis action cannot be undone!\n\nAre you sure?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/queue/clear', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to clear queue');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                await refreshQueue();
                renderMovies();
                renderDTSMovies();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Refresh unified history
        async function refreshHistory() {
            try {
                const response = await fetch('/api/history');
                history = await response.json();
                renderHistory();
            } catch (error) {
                console.error('Error refreshing history:', error);
            }
        }

        // Render unified history
        function renderHistory() {
            const container = document.getElementById('history-container');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="empty-state">No operations yet</div>';
                return;
            }
            
            container.innerHTML = history.map(item => {
                const icon = item.success ? '‚úÖ' : '‚ùå';
                const statusClass = item.success ? 'completed' : 'failed';
                const statusText = item.success ? 'Success' : 'Failed';
                const errorText = item.error ? ` - ${item.error}` : '';
                const operationType = item.operation_type || 'unknown';
                const operationLabel = operationType === 'copy' ? 'Copy' : operationType === 'convert' ? 'Convert' : operationType;
                
                // Show "Try Again" button only for failed convert operations
                const retryButton = !item.success && operationType === 'convert' && item.movie_path ? `
                    <button
                        onclick="retryConversion('${item.movie_path.replace(/'/g, "\\'")}', '${item.movie_title.replace(/'/g, "\\'")}')"
                        class="warning"
                        style="padding: 5px 10px; font-size: 0.85em; margin-top: 5px;"
                    >
                        üîÑ Try Again
                    </button>
                ` : '';
                
                return `
                    <div class="movie-item" style="padding: 8px 12px;">
                        <div class="movie-info" style="display: flex; align-items: center; gap: 10px; width: 100%;">
                            <span style="font-size: 1.2em;">${icon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 0.95em;">
                                    ${item.movie_title}
                                    <span class="operation-badge ${operationType}">${operationLabel}</span>
                                </div>
                                <div style="font-size: 0.8em; color: #aaa;">
                                    <span class="status ${statusClass}" style="padding: 2px 6px; font-size: 0.75em;">${statusText}</span>
                                    ${errorText}
                                </div>
                                ${retryButton}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Retry failed conversion
        async function retryConversion(moviePath, movieTitle) {
            if (!confirm(`Retry conversion for "${movieTitle}"?\n\nThis will re-analyze the file and attempt conversion again.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/convert/retry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ movie_path: moviePath })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to retry conversion');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                await refreshQueue();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // ============================================================================
        // SETTINGS TAB FUNCTIONS
        // ============================================================================

        // Load configuration on page load
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                document.getElementById('radarr_host').value = config.radarr_host || '';
                document.getElementById('radarr_port').value = config.radarr_port || '';
                document.getElementById('radarr_api_key').value = config.radarr_api_key || '';
                
                // Display root folders if they exist
                if (config.ssd_root_folder) {
                    document.getElementById('ssd_root_folder').value = config.ssd_root_folder;
                    document.getElementById('ssd-folder-group').style.display = 'flex';
                }
                if (config.hdd_root_folder) {
                    document.getElementById('hdd_root_folder').value = config.hdd_root_folder;
                    document.getElementById('hdd-folder-group').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Save settings
        async function saveSettings(event) {
            event.preventDefault();
            
            const messageDiv = document.getElementById('settings-message');
            messageDiv.innerHTML = '';
            
            const config = {
                radarr_host: document.getElementById('radarr_host').value,
                radarr_port: document.getElementById('radarr_port').value,
                radarr_api_key: document.getElementById('radarr_api_key').value
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Display detected root folders
                    if (result.ssd_root_folder) {
                        document.getElementById('ssd_root_folder').value = result.ssd_root_folder;
                        document.getElementById('ssd-folder-group').style.display = 'flex';
                    }
                    if (result.hdd_root_folder) {
                        document.getElementById('hdd_root_folder').value = result.hdd_root_folder;
                        document.getElementById('hdd-folder-group').style.display = 'flex';
                    }
                    
                    messageDiv.innerHTML = '<div class="success">‚úÖ Settings saved successfully! Root folders auto-detected.</div>';
                    await loadConfig();
                } else {
                    messageDiv.innerHTML = `<div class="error">‚ùå Error: ${result.error}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // ============================================================================
        // MEDIA INTEGRITY TAB FUNCTIONS
        // ============================================================================

        let integrityConfig = {};
        let integrityStats = {};

        // Load integrity configuration
        async function loadIntegrityConfig() {
            try {
                const response = await fetch('/api/integrity/config');
                integrityConfig = await response.json();
                
                // Populate form
                const directories = integrityConfig.watch_directories || [];
                document.getElementById('integrity-directories').value = directories.join('\n');
                document.getElementById('integrity-test-directory').value = integrityConfig.test_directory || '';
            } catch (error) {
                console.error('Error loading integrity config:', error);
            }
        }

        // Save integrity configuration
        async function saveIntegrityConfig() {
            const directoriesText = document.getElementById('integrity-directories').value;
            const directories = directoriesText.split('\n').map(d => d.trim()).filter(d => d);
            const testDirectory = document.getElementById('integrity-test-directory').value.trim() || null;
            
            try {
                const response = await fetch('/api/integrity/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        watch_directories: directories,
                        test_directory: testDirectory
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save config');
                }
                
                alert('‚úÖ Configuration saved');
                await loadIntegrityConfig();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Refresh integrity statistics
        async function refreshIntegrityStats() {
            const container = document.getElementById('integrity-stats-container');
            container.innerHTML = '<div class="loading">Loading statistics...</div>';
            
            try {
                const response = await fetch('/api/integrity/stats');
                integrityStats = await response.json();
                renderIntegrityStats();
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Render integrity statistics
        function renderIntegrityStats() {
            const container = document.getElementById('integrity-stats-container');
            const stats = integrityStats;
            
            const total = stats.total || 0;
            const verifiedOk = stats.verified_ok || 0;
            const broken = stats.broken || 0;
            const changed = stats.changed || 0;
            const pending = stats.pending || 0;
            
            const okPercent = total > 0 ? (verifiedOk / total * 100).toFixed(1) : 0;
            const brokenPercent = total > 0 ? (broken / total * 100).toFixed(1) : 0;
            const changedPercent = total > 0 ? (changed / total * 100).toFixed(1) : 0;
            const pendingPercent = total > 0 ? (pending / total * 100).toFixed(1) : 0;
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <div style="background: #333; padding: 15px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold;">${total}</div>
                        <div style="color: #aaa; font-size: 0.9em;">Total Files</div>
                    </div>
                    <div style="background: #2d5016; padding: 15px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #66BB6A;">${verifiedOk}</div>
                        <div style="color: #aaa; font-size: 0.9em;">‚úÖ Verified OK (${okPercent}%)</div>
                    </div>
                    <div style="background: #4d1616; padding: 15px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #EF5350;">${broken}</div>
                        <div style="color: #aaa; font-size: 0.9em;">‚ùå Broken (${brokenPercent}%)</div>
                    </div>
                    <div style="background: #4d3516; padding: 15px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #FFA726;">${changed}</div>
                        <div style="color: #aaa; font-size: 0.9em;">‚ö†Ô∏è Changed (${changedPercent}%)</div>
                    </div>
                    <div style="background: #333; padding: 15px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #888;">${pending}</div>
                        <div style="color: #aaa; font-size: 0.9em;">‚è≥ Pending (${pendingPercent}%)</div>
                    </div>
                </div>
            `;
        }

        // Start scan
        async function startScan() {
            try {
                const response = await fetch('/api/integrity/scan/start', { method: 'POST' });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to start scan');
                }
                
                document.getElementById('scan-start-btn').style.display = 'none';
                document.getElementById('scan-stop-btn').style.display = 'block';
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Stop scan
        async function stopScan() {
            try {
                await fetch('/api/integrity/scan/stop', { method: 'POST' });
                document.getElementById('scan-start-btn').style.display = 'block';
                document.getElementById('scan-stop-btn').style.display = 'none';
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Start verify
        async function startVerify() {
            try {
                const response = await fetch('/api/integrity/verify/start', { method: 'POST' });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to start verification');
                }
                
                document.getElementById('verify-start-btn').style.display = 'none';
                document.getElementById('verify-stop-btn').style.display = 'block';
                document.getElementById('verify-resume-btn').style.display = 'none';
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Stop verify
        async function stopVerify() {
            try {
                await fetch('/api/integrity/verify/stop', { method: 'POST' });
                document.getElementById('verify-start-btn').style.display = 'none';
                document.getElementById('verify-stop-btn').style.display = 'none';
                document.getElementById('verify-resume-btn').style.display = 'block';
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Resume verify
        async function resumeVerify() {
            try {
                const response = await fetch('/api/integrity/verify/resume', { method: 'POST' });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to resume verification');
                }
                
                document.getElementById('verify-start-btn').style.display = 'none';
                document.getElementById('verify-stop-btn').style.display = 'block';
                document.getElementById('verify-resume-btn').style.display = 'none';
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Start recheck
        async function startRecheck() {
            try {
                const response = await fetch('/api/integrity/recheck/start', { method: 'POST' });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to start recheck');
                }
                
                document.getElementById('recheck-start-btn').style.display = 'none';
                document.getElementById('recheck-stop-btn').style.display = 'block';
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Stop recheck
        async function stopRecheck() {
            try {
                await fetch('/api/integrity/recheck/stop', { method: 'POST' });
                document.getElementById('recheck-start-btn').style.display = 'block';
                document.getElementById('recheck-stop-btn').style.display = 'none';
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Refresh integrity status
        async function refreshIntegrityStatus() {
            try {
                // Scan status
                const scanResponse = await fetch('/api/integrity/scan/status');
                const scanStatus = await scanResponse.json();
                renderScanStatus(scanStatus);
                
                // Verify status
                const verifyResponse = await fetch('/api/integrity/verify/status');
                const verifyStatus = await verifyResponse.json();
                renderVerifyStatus(verifyStatus);
                
                // Recheck status
                const recheckResponse = await fetch('/api/integrity/recheck/status');
                const recheckStatus = await recheckResponse.json();
                renderRecheckStatus(recheckStatus);
            } catch (error) {
                console.error('Error refreshing integrity status:', error);
            }
        }

        // Render scan status
        function renderScanStatus(status) {
            const container = document.getElementById('scan-status-container');
            const startBtn = document.getElementById('scan-start-btn');
            const stopBtn = document.getElementById('scan-stop-btn');
            
            if (status.status === 'in_progress') {
                container.innerHTML = `
                    <div style="color: #42A5F5;">‚è≥ Scanning directories...</div>
                    <div style="font-size: 0.9em; color: #aaa; margin-top: 5px;">
                        Started: ${new Date(status.started).toLocaleString()}
                    </div>
                `;
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
            } else if (status.status === 'completed') {
                container.innerHTML = `
                    <div style="color: #66BB6A;">‚úÖ Scan completed</div>
                    <div style="font-size: 0.9em; color: #aaa; margin-top: 5px;">
                        Files found: ${status.total_files || 0} | Completed: ${new Date(status.completed).toLocaleString()}
                    </div>
                `;
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
            } else {
                container.innerHTML = '<div class="empty-state">Not started</div>';
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
            }
        }

        // Render verify status
        function renderVerifyStatus(status) {
            const container = document.getElementById('verify-status-container');
            const startBtn = document.getElementById('verify-start-btn');
            const stopBtn = document.getElementById('verify-stop-btn');
            const resumeBtn = document.getElementById('verify-resume-btn');
            
            if (status.status === 'in_progress') {
                const progress = status.total_files > 0 ? (status.current_index / status.total_files * 100).toFixed(1) : 0;
                container.innerHTML = `
                    <div style="color: #42A5F5;">‚è≥ Verifying files...</div>
                    <div class="progress-bar" style="margin: 10px 0;">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div style="font-size: 0.9em; color: #aaa;">
                        Progress: ${status.current_index || 0} / ${status.total_files || 0} (${progress}%)
                    </div>
                    <div style="font-size: 0.85em; color: #888; margin-top: 5px;">
                        Current: ${status.current_file || 'Starting...'}
                    </div>
                `;
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                resumeBtn.style.display = 'none';
            } else if (status.status === 'paused') {
                container.innerHTML = `
                    <div style="color: #FFA726;">‚è∏ Verification paused</div>
                    <div style="font-size: 0.9em; color: #aaa; margin-top: 5px;">
                        Progress: ${status.current_index || 0} / ${status.total_files || 0}
                    </div>
                `;
                startBtn.style.display = 'none';
                stopBtn.style.display = 'none';
                resumeBtn.style.display = 'block';
            } else if (status.status === 'completed') {
                container.innerHTML = `
                    <div style="color: #66BB6A;">‚úÖ Verification completed</div>
                    <div style="font-size: 0.9em; color: #aaa; margin-top: 5px;">
                        Completed: ${new Date(status.completed).toLocaleString()}
                    </div>
                `;
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
                resumeBtn.style.display = 'none';
            } else {
                container.innerHTML = '<div class="empty-state">Not started</div>';
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
                resumeBtn.style.display = 'none';
            }
        }

        // Render recheck status
        function renderRecheckStatus(status) {
            const container = document.getElementById('recheck-status-container');
            const startBtn = document.getElementById('recheck-start-btn');
            const stopBtn = document.getElementById('recheck-stop-btn');
            
            if (status.status === 'in_progress') {
                const progress = status.total_files > 0 ? (status.current_index / status.total_files * 100).toFixed(1) : 0;
                container.innerHTML = `
                    <div style="color: #42A5F5;">‚è≥ Rechecking checksums...</div>
                    <div class="progress-bar" style="margin: 10px 0;">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div style="font-size: 0.9em; color: #aaa;">
                        Progress: ${status.current_index || 0} / ${status.total_files || 0} (${progress}%)
                    </div>
                `;
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
            } else if (status.status === 'completed') {
                container.innerHTML = `
                    <div style="color: #66BB6A;">‚úÖ Recheck completed</div>
                    <div style="font-size: 0.9em; color: #aaa; margin-top: 5px;">
                        Completed: ${new Date(status.completed).toLocaleString()}
                    </div>
                `;
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
            } else {
                container.innerHTML = '<div class="empty-state">Not started</div>';
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
            }
        }

        // Refresh integrity issues
        async function refreshIntegrityIssues() {
            const container = document.getElementById('integrity-issues-container');
            container.innerHTML = '<div class="loading">Loading issues...</div>';
            
            try {
                const [brokenResponse, changedResponse] = await Promise.all([
                    fetch('/api/integrity/files/broken'),
                    fetch('/api/integrity/files/changed')
                ]);
                
                const brokenFiles = await brokenResponse.json();
                const changedFiles = await changedResponse.json();
                
                renderIntegrityIssues(brokenFiles, changedFiles);
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Render integrity issues
        function renderIntegrityIssues(brokenFiles, changedFiles) {
            const container = document.getElementById('integrity-issues-container');
            
            const brokenCount = Object.keys(brokenFiles).length;
            const changedCount = Object.keys(changedFiles).length;
            
            if (brokenCount === 0 && changedCount === 0) {
                container.innerHTML = '<div class="empty-state">No issues found</div>';
                return;
            }
            
            let html = '';
            
            if (brokenCount > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #EF5350;">
                            ‚ùå Broken Files (${brokenCount})
                        </div>
                        ${Object.entries(brokenFiles).slice(0, 10).map(([path, data]) => {
                            const warningHtml = data.warning ? `
                                <div style="font-size: 0.75em; color: #FFA726; margin-top: 3px; padding: 3px 6px; background: rgba(255, 167, 38, 0.1); border-radius: 3px;">
                                    ‚ö†Ô∏è Non-critical: ${data.warning.substring(0, 150)}${data.warning.length > 150 ? '...' : ''}
                                </div>
                            ` : '';
                            return `
                                <div class="movie-item" style="padding: 8px 12px;">
                                    <div style="font-size: 0.9em; font-family: monospace; color: #e0e0e0;">${path}</div>
                                    <div style="font-size: 0.8em; color: #EF5350; margin-top: 3px;">${data.error || 'Unknown error'}</div>
                                    ${warningHtml}
                                </div>
                            `;
                        }).join('')}
                        ${brokenCount > 10 ? `
                            <div style="text-align: center; margin-top: 10px;">
                                <a href="/api/integrity/export-issues" target="_blank" style="color: #4CAF50; text-decoration: underline; cursor: pointer;">
                                    üìÑ ... and ${brokenCount - 10} more (click to export all)
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            if (changedCount > 0) {
                html += `
                    <div>
                        <div style="font-weight: bold; margin-bottom: 10px; color: #FFA726;">
                            ‚ö†Ô∏è Changed Checksums (${changedCount})
                        </div>
                        ${Object.entries(changedFiles).slice(0, 10).map(([path, data]) => `
                            <div class="movie-item" style="padding: 8px 12px;">
                                <div style="font-size: 0.9em; font-family: monospace; color: #e0e0e0;">${path}</div>
                                <div style="font-size: 0.8em; color: #FFA726; margin-top: 3px;">Checksum mismatch - possible corruption</div>
                            </div>
                        `).join('')}
                        ${changedCount > 10 ? `
                            <div style="text-align: center; margin-top: 10px;">
                                <a href="/api/integrity/export-issues" target="_blank" style="color: #4CAF50; text-decoration: underline; cursor: pointer;">
                                    üìÑ ... and ${changedCount - 10} more (click to export all)
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // Reset integrity data
        async function resetIntegrityData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL integrity data including checksums and verification results.\n\nThis action cannot be undone!\n\nAre you sure?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/integrity/reset', { method: 'POST' });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to reset data');
                }
                
                alert('‚úÖ All integrity data has been reset');
                await refreshIntegrityStats();
                await refreshIntegrityIssues();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Clear integrity reports
        async function clearIntegrityReports() {
            if (!confirm('Clear all broken/changed file reports?\n\nThis will reset their status to pending for re-verification.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/integrity/clear-reports', { method: 'POST' });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to clear reports');
                }
                
                alert('‚úÖ Reports cleared');
                await refreshIntegrityStats();
                await refreshIntegrityIssues();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Reset broken files to pending
        async function resetBrokenFiles() {
            if (!confirm('Reset broken files to pending?\n\nThis will allow you to re-verify them by clicking Start Verify.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/integrity/reset-broken', { method: 'POST' });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to reset broken files');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                await refreshIntegrityStats();
                await refreshIntegrityIssues();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // ============================================================================
        // AUTO-REFRESH AND INITIALIZATION
        // ============================================================================

        // Auto-refresh queue, history, and integrity status every 2 seconds
        setInterval(() => {
            refreshQueue();
            refreshHistory();
            refreshIntegrityStatus();
        }, 2000);

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
            await loadIntegrityConfig();
            await refreshQueue();
            await refreshHistory();
        });
    </script>
</body>
</html>