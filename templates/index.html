<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radarr Safe Mover</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        h1 {
            text-align: center;
            padding: 15px 0;
            background: #2a2a2a;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #4CAF50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            margin-bottom: 10px;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        button.secondary {
            background: #2196F3;
        }

        button.secondary:hover {
            background: #0b7dda;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover {
            background: #da190b;
        }

        .movie-item, .queue-item {
            background: #333;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .movie-info, .queue-info {
            flex: 1;
            min-width: 200px;
        }

        .movie-title, .queue-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .movie-details, .queue-details {
            font-size: 0.9em;
            color: #aaa;
        }

        .movie-actions, .queue-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            width: 100%;
        }

        .movie-actions button, .queue-actions button {
            flex: 1;
            margin: 0;
        }

        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
        }

        .status.pending {
            background: #FFA726;
            color: #000;
        }

        .status.copying {
            background: #42A5F5;
            color: #fff;
        }

        .status.verifying {
            background: #AB47BC;
            color: #fff;
        }

        .status.updating {
            background: #26C6DA;
            color: #000;
        }

        .status.completed {
            background: #66BB6A;
            color: #000;
        }

        .status.failed {
            background: #EF5350;
            color: #fff;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        input, select {
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #1a1a1a;
            color: #e0e0e0;
            font-size: 1em;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .error {
            background: #f44336;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .success {
            background: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .progress-text {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 5px;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 800px;
                padding: 20px;
            }

            .movie-actions, .queue-actions {
                width: auto;
                margin-top: 0;
            }

            .movie-actions button, .queue-actions button {
                width: auto;
                flex: 0;
            }
        }
    </style>
</head>
<body>
    <h1>üé¨ Radarr Safe Mover</h1>
    
    <div class="container">
        <!-- Movies Section -->
        <div class="section">
            <div class="section-title">
                <span>üìÅ Movies on SSD</span>
                <button onclick="refreshMovies()" style="width: auto; margin: 0; padding: 8px 15px;">üîÑ Refresh</button>
            </div>
            <div id="movies-container">
                <div class="loading">Loading movies...</div>
            </div>
        </div>

        <!-- Queue Section -->
        <div class="section">
            <div class="section-title">
                <span>üìã Copy Queue</span>
            </div>
            <div id="queue-container">
                <div class="empty-state">No items in queue</div>
            </div>
        </div>

        <!-- History Section -->
        <div class="section">
            <div class="section-title">
                <span>üìú Recent Operations</span>
            </div>
            <div id="history-container">
                <div class="empty-state">No operations yet</div>
            </div>
        </div>

        <!-- Leftovers Section -->
        <div class="section">
            <div class="section-title">
                <span>üóëÔ∏è Leftover Files</span>
                <button onclick="refreshLeftovers()" style="width: auto; margin: 0; padding: 8px 15px;">üîÑ Refresh</button>
            </div>
            <div id="leftovers-container">
                <div class="empty-state">Click Refresh to scan for leftover files</div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="section">
            <div class="section-title">
                <span>‚öôÔ∏è Settings</span>
            </div>
            <div id="settings-message"></div>
            <form class="settings-form" onsubmit="saveSettings(event)">
                <div class="form-group">
                    <label>Radarr Host:</label>
                    <input type="text" id="radarr_host" placeholder="192.168.1.100" required>
                </div>
                <div class="form-group">
                    <label>Radarr Port:</label>
                    <input type="text" id="radarr_port" placeholder="7878" required>
                </div>
                <div class="form-group">
                    <label>Radarr API Key:</label>
                    <input type="text" id="radarr_api_key" placeholder="your-api-key" required>
                </div>
                <div class="form-group" id="ssd-folder-group" style="display: none;">
                    <label>SSD Root Folder (auto-detected):</label>
                    <input type="text" id="ssd_root_folder" readonly style="background: #2a2a2a; cursor: not-allowed;">
                </div>
                <div class="form-group" id="hdd-folder-group" style="display: none;">
                    <label>HDD Root Folder (auto-detected):</label>
                    <input type="text" id="hdd_root_folder" readonly style="background: #2a2a2a; cursor: not-allowed;">
                </div>
                <button type="submit">üíæ Save Settings</button>
            </form>
        </div>

        <!-- Emergency Controls Section -->
        <div class="section">
            <div class="section-title">
                <span>üö® Emergency Controls</span>
            </div>
            <button onclick="clearQueue()" class="danger">
                üóëÔ∏è Force Clear Queue
            </button>
            <p style="font-size: 0.85em; color: #888; margin-top: 10px; text-align: center;">
                Use this to forcefully clear all items from the queue, including currently processing items.
            </p>
        </div>
    </div>

    <script>
        let movies = [];
        let queue = [];
        let history = [];
        let leftovers = [];

        // Refresh leftovers list
        async function refreshLeftovers() {
            const container = document.getElementById('leftovers-container');
            container.innerHTML = '<div class="loading">Scanning for leftover files...</div>';
            
            try {
                const response = await fetch('/api/leftovers');
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to load leftovers');
                }
                
                leftovers = await response.json();
                renderLeftovers();
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Render leftovers list
        function renderLeftovers() {
            const container = document.getElementById('leftovers-container');
            
            if (leftovers.length === 0) {
                container.innerHTML = '<div class="empty-state">No leftover files found</div>';
                return;
            }
            
            container.innerHTML = leftovers.map(leftover => {
                const size = (leftover.size / 1024 / 1024 / 1024).toFixed(2) + ' GB';
                const fileCount = leftover.file_count;
                
                // Build buttons based on can_recopy flag
                let buttons = '';
                if (leftover.can_recopy) {
                    buttons = `
                        <button
                            onclick="recopyLeftover(${leftover.movie_id}, '${leftover.name.replace(/'/g, "\\'")}', '${leftover.path.replace(/'/g, "\\'")}' )"
                            class="secondary"
                            style="flex: 1;"
                        >
                            üîÑ Re-copy
                        </button>
                        <button
                            onclick="deleteLeftover('${leftover.path.replace(/'/g, "\\'")}', '${leftover.name.replace(/'/g, "\\'")}')"
                            class="danger"
                            style="flex: 1;"
                        >
                            üóëÔ∏è Delete
                        </button>
                    `;
                } else {
                    buttons = `
                        <button
                            onclick="deleteLeftover('${leftover.path.replace(/'/g, "\\'")}', '${leftover.name.replace(/'/g, "\\'")}')"
                            class="danger"
                        >
                            üóëÔ∏è Delete
                        </button>
                    `;
                }
                
                return `
                    <div class="movie-item">
                        <div class="movie-info">
                            <div class="movie-title">${leftover.name}</div>
                            <div class="movie-details">
                                üì¶ ${size} | üìÑ ${fileCount} file${fileCount !== 1 ? 's' : ''}
                                ${leftover.can_recopy ? ' | ‚ö†Ô∏è Missing on HDD' : ''}
                            </div>
                            <div class="movie-details" style="font-size: 0.75em; color: #888; margin-top: 3px;">
                                ${leftover.path}
                            </div>
                        </div>
                        <div class="movie-actions">
                            ${buttons}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Re-copy leftover to queue
        async function recopyLeftover(movieId, name, ssdPath) {
            if (!confirm(`Re-copy "${name}" from SSD to HDD?\n\nThis will add the movie to the copy queue.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/leftovers/recopy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        movie_id: movieId,
                        ssd_path: ssdPath
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add to queue');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                await refreshQueue();
                await refreshLeftovers();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Delete leftover with confirmation
        async function deleteLeftover(path, name) {
            if (!confirm(`Are you sure you want to delete "${name}" and all its contents?\n\nThis action cannot be undone!`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/leftovers', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete leftover');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                await refreshLeftovers();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Load configuration on page load
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                document.getElementById('radarr_host').value = config.radarr_host || '';
                document.getElementById('radarr_port').value = config.radarr_port || '';
                document.getElementById('radarr_api_key').value = config.radarr_api_key || '';
                
                // Display root folders if they exist
                if (config.ssd_root_folder) {
                    document.getElementById('ssd_root_folder').value = config.ssd_root_folder;
                    document.getElementById('ssd-folder-group').style.display = 'flex';
                }
                if (config.hdd_root_folder) {
                    document.getElementById('hdd_root_folder').value = config.hdd_root_folder;
                    document.getElementById('hdd-folder-group').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Save settings
        async function saveSettings(event) {
            event.preventDefault();
            
            const messageDiv = document.getElementById('settings-message');
            messageDiv.innerHTML = '';
            
            const config = {
                radarr_host: document.getElementById('radarr_host').value,
                radarr_port: document.getElementById('radarr_port').value,
                radarr_api_key: document.getElementById('radarr_api_key').value
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Display detected root folders
                    if (result.ssd_root_folder) {
                        document.getElementById('ssd_root_folder').value = result.ssd_root_folder;
                        document.getElementById('ssd-folder-group').style.display = 'flex';
                    }
                    if (result.hdd_root_folder) {
                        document.getElementById('hdd_root_folder').value = result.hdd_root_folder;
                        document.getElementById('hdd-folder-group').style.display = 'flex';
                    }
                    
                    messageDiv.innerHTML = '<div class="success">‚úÖ Settings saved successfully! Root folders auto-detected.</div>';
                    await loadConfig();
                    await refreshMovies();
                } else {
                    messageDiv.innerHTML = `<div class="error">‚ùå Error: ${result.error}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Refresh movies list
        async function refreshMovies() {
            const container = document.getElementById('movies-container');
            container.innerHTML = '<div class="loading">Loading movies...</div>';
            
            try {
                const response = await fetch('/api/movies');
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to load movies');
                }
                
                movies = await response.json();
                renderMovies();
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Render movies list
        function renderMovies() {
            const container = document.getElementById('movies-container');
            
            if (movies.length === 0) {
                container.innerHTML = '<div class="empty-state">No movies found on SSD</div>';
                return;
            }
            
            container.innerHTML = movies.map(movie => {
                const movieFile = movie.movieFile || {};
                const size = movieFile.size ? (movieFile.size / 1024 / 1024 / 1024).toFixed(2) + ' GB' : 'Unknown';
                const quality = movieFile.quality?.quality?.name || 'Unknown';
                
                const inQueue = queue.some(item => item.movie.id === movie.id);
                
                return `
                    <div class="movie-item">
                        <div class="movie-info">
                            <div class="movie-title">${movie.title} (${movie.year})</div>
                            <div class="movie-details">
                                üì¶ ${size} | üé• ${quality}
                            </div>
                        </div>
                        <div class="movie-actions">
                            <button 
                                onclick="addToQueue(${movie.id})" 
                                ${inQueue ? 'disabled' : ''}
                                class="secondary"
                            >
                                ${inQueue ? '‚úì In Queue' : '‚ûï Add to Queue'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Add movie to queue
        async function addToQueue(movieId) {
            const movie = movies.find(m => m.id === movieId);
            if (!movie) return;
            
            try {
                const response = await fetch('/api/queue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ movie })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add to queue');
                }
                
                await refreshQueue();
                renderMovies();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Refresh queue
        async function refreshQueue() {
            try {
                const response = await fetch('/api/queue');
                queue = await response.json();
                renderQueue();
            } catch (error) {
                console.error('Error refreshing queue:', error);
            }
        }

        // Refresh history
        async function refreshHistory() {
            try {
                const response = await fetch('/api/history');
                history = await response.json();
                renderHistory();
            } catch (error) {
                console.error('Error refreshing history:', error);
            }
        }

        // Render history
        function renderHistory() {
            const container = document.getElementById('history-container');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="empty-state">No operations yet</div>';
                return;
            }
            
            container.innerHTML = history.map(item => {
                const icon = item.success ? '‚úÖ' : '‚ùå';
                const statusClass = item.success ? 'completed' : 'failed';
                const statusText = item.success ? 'Success' : 'Failed';
                const errorText = item.error ? ` - ${item.error}` : '';
                
                return `
                    <div class="movie-item" style="padding: 8px 12px;">
                        <div class="movie-info" style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.2em;">${icon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 0.95em;">${item.movie_title}</div>
                                <div style="font-size: 0.8em; color: #aaa;">
                                    <span class="status ${statusClass}" style="padding: 2px 6px; font-size: 0.75em;">${statusText}</span>
                                    ${errorText}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render queue
        function renderQueue() {
            const container = document.getElementById('queue-container');
            
            if (queue.length === 0) {
                container.innerHTML = '<div class="empty-state">No items in queue</div>';
                return;
            }
            
            container.innerHTML = queue.map(item => {
                const movie = item.movie;
                const movieFile = movie.movieFile || {};
                const size = movieFile.size ? (movieFile.size / 1024 / 1024 / 1024).toFixed(2) + ' GB' : 'Unknown';
                
                return `
                    <div class="queue-item">
                        <div class="queue-info">
                            <div class="queue-title">${movie.title} (${movie.year})</div>
                            <div class="queue-details">üì¶ ${size}</div>
                            <div class="status ${item.status}">${item.status.toUpperCase()}</div>
                            <div class="progress-text">${item.progress}</div>
                        </div>
                        <div class="queue-actions">
                            ${item.status === 'pending' ? `
                                <button onclick="removeFromQueue('${item.id}')" class="danger">
                                    üóëÔ∏è Remove
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Remove from queue
        async function removeFromQueue(itemId) {
            try {
                const response = await fetch(`/api/queue/${itemId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to remove from queue');
                }
                
                await refreshQueue();
                renderMovies();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        // Force clear entire queue
        async function clearQueue() {
            if (!confirm('‚ö†Ô∏è WARNING: This will forcefully clear ALL items from the queue, including any currently processing items.\n\nThis action cannot be undone!\n\nAre you sure?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/queue/clear', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to clear queue');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                await refreshQueue();
                renderMovies();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }


        // Auto-refresh queue and history every 2 seconds
        setInterval(() => {
            refreshQueue();
            refreshHistory();
        }, 2000);

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
            await refreshQueue();
            await refreshHistory();
        });
    </script>
</body>
</html>