<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Radarr Toolbox</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        h1 {
            text-align: center;
            padding: 15px 0;
            background: #2a2a2a;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            background: #2a2a2a;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #888;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #333;
            color: #e0e0e0;
        }

        .tab.active {
            background: #4CAF50;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #4CAF50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            margin-bottom: 10px;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        button.secondary {
            background: #2196F3;
        }

        button.secondary:hover {
            background: #0b7dda;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover {
            background: #da190b;
        }

        button.warning {
            background: #FF9800;
        }

        button.warning:hover {
            background: #e68900;
        }

        .movie-item, .queue-item {
            background: #333;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .movie-info, .queue-info {
            flex: 1;
            min-width: 200px;
        }

        .movie-title, .queue-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .movie-details, .queue-details {
            font-size: 0.9em;
            color: #aaa;
        }

        .movie-actions, .queue-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            width: 100%;
        }

        .movie-actions button, .queue-actions button {
            flex: 1;
            margin: 0;
        }

        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
        }

        .status.pending {
            background: #FFA726;
            color: #000;
        }

        .status.copying, .status.processing {
            background: #42A5F5;
            color: #fff;
        }

        .status.verifying {
            background: #AB47BC;
            color: #fff;
        }

        .status.updating {
            background: #26C6DA;
            color: #000;
        }

        .status.completed {
            background: #66BB6A;
            color: #000;
        }

        .status.failed {
            background: #EF5350;
            color: #fff;
        }

        .operation-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 8px;
        }

        .operation-badge.copy {
            background: #2196F3;
            color: white;
        }

        .operation-badge.convert {
            background: #FF9800;
            color: white;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge.success {
            background: #66BB6A;
            color: white;
        }

        .badge.warning {
            background: #FFA726;
            color: white;
        }

        .badge.info {
            background: #42A5F5;
            color: white;
        }

        .series-item {
            background: #333;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .series-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .series-title {
            font-weight: bold;
            font-size: 1.1em;
        }

        .series-details {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 5px;
        }

        .series-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .series-actions button {
            flex: 1;
            margin: 0;
        }

        .seasons-container {
            display: none;
            margin-top: 15px;
            padding-left: 15px;
            border-left: 3px solid #4CAF50;
        }

        .seasons-container.expanded {
            display: block;
        }

        .season-item {
            background: #2a2a2a;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .season-info {
            flex: 1;
            min-width: 200px;
        }

        .season-title {
            font-weight: bold;
        }

        .season-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .season-actions button {
            padding: 5px 10px;
            font-size: 0.85em;
        }

        .info-icon {
            cursor: pointer;
            background: #42A5F5;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            margin-left: 5px;
        }

        .verification-progress {
            background: #2a2a2a;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 2px solid #4CAF50;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #66BB6A);
            transition: width 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        input, select {
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #1a1a1a;
            color: #e0e0e0;
            font-size: 1em;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .error {
            background: #f44336;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .success {
            background: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .progress-text {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 5px;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 900px;
                padding: 20px;
            }

            .movie-actions, .queue-actions {
                width: auto;
                margin-top: 0;
            }

            .movie-actions button, .queue-actions button {
                width: auto;
                flex: 0;
            }
        }
    </style>
</head>
<body>
    <h1>üé¨ Ultimate Radarr Toolbox</h1>
    
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('safe-copy')">üì¶ Safe Copy</button>
            <button class="tab" onclick="switchTab('dts-converter')">üéµ DTS Converter</button>
            <button class="tab" onclick="switchTab('tv-verification')">üì∫ TV Verification</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <!-- Safe Copy Tab -->
        <div id="safe-copy" class="tab-content active">
            <!-- Movies Section -->
            <div class="section">
                <div class="section-title">
                    <span>üìÅ Movies on SSD</span>
                    <button onclick="refreshMovies()" style="width: auto; margin: 0; padding: 8px 15px;">üîÑ Refresh</button>
                </div>
                <div id="movies-container">
                    <div class="loading">Loading movies...</div>
                </div>
            </div>

            <!-- Leftovers Section -->
            <div class="section">
                <div class="section-title">
                    <span>üóëÔ∏è Leftover Files</span>
                    <button onclick="refreshLeftovers()" style="width: auto; margin: 0; padding: 8px 15px;">üîÑ Refresh</button>
                </div>
                <div id="leftovers-container">
                    <div class="empty-state">Click Refresh to scan for leftover files</div>
                </div>
            </div>
        </div>

        <!-- TV Verification Tab -->
        <div id="tv-verification" class="tab-content">
            <!-- Verification Progress -->
            <div id="verification-progress-container"></div>

            <!-- TV Shows Section -->
            <div class="section">
                <div class="section-title">
                    <span>üì∫ TV Shows on HDD</span>
                    <button onclick="refreshShows()" style="width: auto; margin: 0; padding: 8px 15px;">üîÑ Refresh</button>
                </div>
                <div id="shows-container">
                    <div class="loading">Loading TV shows...</div>
                </div>
            </div>
        </div>

        <!-- DTS Converter Tab -->
        <div id="dts-converter" class="tab-content">
            <!-- DTS Movies Section -->
            <div class="section">
                <div class="section-title">
                    <span>üéµ Movies with DTS Audio</span>
                    <button onclick="refreshDTSMovies()" style="width: auto; margin: 0; padding: 8px 15px;">üîÑ Refresh</button>
                </div>
                <div id="dts-movies-container">
                    <div class="loading">Loading DTS movies...</div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="section">
                <div class="section-title">
                    <span>‚öôÔ∏è Radarr Configuration</span>
                </div>
                <div id="settings-message"></div>
                <form class="settings-form" onsubmit="saveSettings(event)">
                    <div class="form-group">
                        <label>Radarr Host:</label>
                        <input type="text" id="radarr_host" placeholder="192.168.1.100" required>
                    </div>
                    <div class="form-group">
                        <label>Radarr Port:</label>
                        <input type="text" id="radarr_port" placeholder="7878" required>
                    </div>
                    <div class="form-group">
                        <label>Radarr API Key:</label>
                        <input type="text" id="radarr_api_key" placeholder="your-api-key" required>
                    </div>
                    <div class="form-group">
                        <label>Sonarr Host:</label>
                        <input type="text" id="sonarr_host" placeholder="192.168.1.100">
                    </div>
                    <div class="form-group">
                        <label>Sonarr Port:</label>
                        <input type="text" id="sonarr_port" placeholder="8989">
                    </div>
                    <div class="form-group">
                        <label>Sonarr API Key:</label>
                        <input type="text" id="sonarr_api_key" placeholder="your-sonarr-api-key">
                    </div>
                    <div class="form-group" id="ssd-folder-group" style="display: none;">
                        <label>SSD Root Folder (auto-detected):</label>
                        <input type="text" id="ssd_root_folder" readonly style="background: #2a2a2a; cursor: not-allowed;">
                    </div>
                    <div class="form-group" id="hdd-folder-group" style="display: none;">
                        <label>HDD Root Folder (auto-detected):</label>
                        <input type="text" id="hdd_root_folder" readonly style="background: #2a2a2a; cursor: not-allowed;">
                    </div>
                    <div class="form-group" id="shows-hdd-folder-group" style="display: none;">
                        <label>Shows HDD Root Folder (auto-detected):</label>
                        <input type="text" id="shows_hdd_root_folder" readonly style="background: #2a2a2a; cursor: not-allowed;">
                    </div>
                    <button type="submit">üíæ Save Settings</button>
                </form>
            </div>
        </div>

        <!-- Unified Queue Section (shown on all tabs) -->
        <div class="section">
            <div class="section-title">
                <span>üìã Unified Operation Queue</span>
            </div>
            <div id="queue-container">
                <div class="empty-state">No items in queue</div>
            </div>
        </div>

        <!-- Unified History Section (shown on all tabs) -->
        <div class="section">
            <div class="section-title">
                <span>üìú Recent Operations</span>
            </div>
            <div id="history-container">
                <div class="empty-state">No operations yet</div>
            </div>
        </div>

        <!-- Emergency Controls Section -->
        <div class="section">
            <div class="section-title">
                <span>üö® Emergency Controls</span>
            </div>
            <button onclick="clearQueue()" class="danger">
                üóëÔ∏è Force Clear Queue
            </button>
            <p style="font-size: 0.85em; color: #888; margin-top: 10px; text-align: center;">
                Use this to forcefully clear all items from the unified queue, including currently processing items.
            </p>
        </div>
    </div>

    <script>
        let movies = [];
        let dtsMovies = [];
        let queue = [];
        let history = [];
        let shows = [];
        let expandedSeries = {};
        let verificationStatus = null;
        let leftovers = [];

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Don't auto-load data - user must click Refresh button
        }

        // ============================================================================
        // SAFE COPY TAB FUNCTIONS
        // ============================================================================

        // Refresh movies list
        async function refreshMovies() {
            const container = document.getElementById('movies-container');
            container.innerHTML = '<div class="loading">Loading movies...</div>';
            
            try {
                const response = await fetch('/api/movies');
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to load movies');
                }
                
                movies = await response.json();
                renderMovies();
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Render movies list
        function renderMovies() {
            const container = document.getElementById('movies-container');
            
            if (movies.length === 0) {
                container.innerHTML = '<div class="empty-state">No movies found on SSD</div>';
                return;
            }
            
            container.innerHTML = movies.map(movie => {
                const movieFile = movie.movieFile || {};
                const size = movieFile.size ? (movieFile.size / 1024 / 1024 / 1024).toFixed(2) + ' GB' : 'Unknown';
                const quality = movieFile.quality?.quality?.name || 'Unknown';
                
                const inQueue = queue.some(item => item.movie.id === movie.id);
                
                return `
                    <div class="movie-item">
                        <div class="movie-info">
                            <div class="movie-title">${movie.title} (${movie.year})</div>
                            <div class="movie-details">
                                üì¶ ${size} | üé• ${quality}
                            </div>
                        </div>
                        <div class="movie-actions">
                            <button 
                                onclick="addToQueue(${movie.id}, 'copy')" 
                                ${inQueue ? 'disabled' : ''}
                                class="secondary"
                            >
                                ${inQueue ? '‚úì In Queue' : '‚ûï Add to Queue'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Refresh leftovers list
        async function refreshLeftovers() {
            const container = document.getElementById('leftovers-container');
            container.innerHTML = '<div class="loading">Scanning for leftover files...</div>';
            
            try {
                const response = await fetch('/api/leftovers');
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to load leftovers');
                }
                
                leftovers = await response.json();
                renderLeftovers();
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Render leftovers list
        function renderLeftovers() {
            const container = document.getElementById('leftovers-container');
            
            if (leftovers.length === 0) {
                container.innerHTML = '<div class="empty-state">No leftover files found</div>';
                return;
            }
            
            container.innerHTML = leftovers.map(leftover => {
                const size = (leftover.size / 1024 / 1024 / 1024).toFixed(2) + ' GB';
                const fileCount = leftover.file_count;
                
                let buttons = '';
                if (leftover.can_recopy) {
                    buttons = `
                        <button
                            onclick="recopyLeftover(${leftover.movie_id}, '${leftover.name.replace(/'/g, "\\'")}', '${leftover.path.replace(/'/g, "\\'")}' )"
                            class="secondary"
                            style="flex: 1;"
                        >
                            üîÑ Re-copy
                        </button>
                        <button
                            onclick="deleteLeftover('${leftover.path.replace(/'/g, "\\'")}', '${leftover.name.replace(/'/g, "\\'")}')"
                            class="danger"
                            style="flex: 1;"
                        >
                            üóëÔ∏è Delete
                        </button>
                    `;
                } else {
                    buttons = `
                        <button
                            onclick="deleteLeftover('${leftover.path.replace(/'/g, "\\'")}', '${leftover.name.replace(/'/g, "\\'")}')"
                            class="danger"
                        >
                            üóëÔ∏è Delete
                        </button>
                    `;
                }
                
                return `
                    <div class="movie-item">
                        <div class="movie-info">
                            <div class="movie-title">${leftover.name}</div>
                            <div class="movie-details">
                                üì¶ ${size} | üìÑ ${fileCount} file${fileCount !== 1 ? 's' : ''}
                                ${leftover.can_recopy ? ' | ‚ö†Ô∏è Missing on HDD' : ''}
                            </div>
                            <div class="movie-details" style="font-size: 0.75em; color: #888; margin-top: 3px;">
                                ${leftover.path}
                            </div>
                        </div>
                        <div class="movie-actions">
                            ${buttons}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Re-copy leftover to queue
        async function recopyLeftover(movieId, name, ssdPath) {
            if (!confirm(`Re-copy "${name}" from SSD to HDD?\n\nThis will add the movie to the copy queue.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/leftovers/recopy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        movie_id: movieId,
                        ssd_path: ssdPath
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add to queue');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                await refreshQueue();
                await refreshLeftovers();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Delete leftover with confirmation
        async function deleteLeftover(path, name) {
            if (!confirm(`Are you sure you want to delete "${name}" and all its contents?\n\nThis action cannot be undone!`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/leftovers', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete leftover');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                await refreshLeftovers();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // ============================================================================
        // ============================================================================
        // TV VERIFICATION TAB FUNCTIONS
        // ============================================================================

        // Refresh TV shows list
        async function refreshShows() {
            const container = document.getElementById('shows-container');
            container.innerHTML = '<div class="loading">Loading TV shows...</div>';
            
            try {
                const response = await fetch('/api/shows');
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to load shows');
                }
                
                shows = await response.json();
                renderShows();
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Render TV shows list
        function renderShows() {
            const container = document.getElementById('shows-container');
            
            if (shows.length === 0) {
                container.innerHTML = '<div class="empty-state">No TV shows found on HDD</div>';
                return;
            }
            
            container.innerHTML = shows.map(series => {
                const isExpanded = expandedSeries[series.id] || false;
                const arrow = isExpanded ? '‚ñº' : '‚ñ∂';
                
                console.log('Rendering series:', series.id, series.title);
                
                return `
                    <div class="series-item">
                        <div class="series-header" onclick="toggleSeries(${series.id})">
                            <div>
                                <div class="series-title">${arrow} ${series.title} (${series.year || 'N/A'})</div>
                                <div class="series-details">
                                    üì∫ ${series.seasonCount || 0} seasons
                                </div>
                            </div>
                        </div>
                        <div class="series-actions" onclick="event.stopPropagation()">
                            <button onclick="console.log('Button clicked for series:', ${series.id}); verifySeries(${series.id})" class="secondary">
                                ‚úì Verify All Seasons
                            </button>
                        </div>
                        <div id="seasons-${series.id}" class="seasons-container ${isExpanded ? 'expanded' : ''}">
                            <div class="loading">Loading seasons...</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle series expansion
        async function toggleSeries(seriesId) {
            expandedSeries[seriesId] = !expandedSeries[seriesId];
            
            const container = document.getElementById(`seasons-${seriesId}`);
            if (!container) return;
            
            if (expandedSeries[seriesId]) {
                container.classList.add('expanded');
                container.innerHTML = '<div class="loading">Loading seasons...</div>';
                await loadSeasons(seriesId);
            } else {
                container.classList.remove('expanded');
            }
            
            // Update arrow only
            const series = shows.find(s => s.id === seriesId);
            if (series) {
                const arrow = expandedSeries[seriesId] ? '‚ñº' : '‚ñ∂';
                const titleElement = container.closest('.series-item').querySelector('.series-title');
                if (titleElement) {
                    titleElement.innerHTML = `${arrow} ${series.title} (${series.year || 'N/A'})`;
                }
            }
        }

        // Load seasons for a series
        async function loadSeasons(seriesId) {
            const container = document.getElementById(`seasons-${seriesId}`);
            if (!container) return;
            
            try {
                const response = await fetch(`/api/shows/${seriesId}/seasons`);
                if (!response.ok) {
                    throw new Error('Failed to load seasons');
                }
                
                const seasons = await response.json();
                renderSeasons(seriesId, seasons);
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Render seasons for a series
        function renderSeasons(seriesId, seasons) {
            const container = document.getElementById(`seasons-${seriesId}`);
            if (!container) return;
            
            if (seasons.length === 0) {
                container.innerHTML = '<div class="empty-state">No seasons found</div>';
                return;
            }
            
            container.innerHTML = seasons.map(season => {
                const vData = season.verification_data || {};
                const status = vData.status || 'unchecked';
                const verifiedCount = (vData.verified_files || []).length;
                const brokenCount = (vData.broken_files || []).length;
                const totalFiles = season.fileCount;
                const lastChecked = vData.last_checked ? new Date(vData.last_checked).toLocaleString() : 'Never';
                
                let statusBadge = '';
                if (status === 'completed' && brokenCount === 0) {
                    statusBadge = `<span class="badge success">‚úì ${verifiedCount} files OK</span>`;
                } else if (status === 'completed' && brokenCount > 0) {
                    statusBadge = `<span class="badge warning">‚ö† ${brokenCount} broken</span>`;
                } else if (status === 'checking') {
                    statusBadge = `<span class="badge info">‚è≥ Checking...</span>`;
                } else if (status === 'paused') {
                    statusBadge = `<span class="badge warning">‚è∏ Paused</span>`;
                }
                
                const infoButton = brokenCount > 0 ? `
                    <span class="info-icon" onclick="showBrokenFiles(${seriesId}, ${season.seasonNumber})" title="Show broken files">i</span>
                ` : '';
                
                return `
                    <div class="season-item">
                        <div class="season-info">
                            <div class="season-title">
                                Season ${season.seasonNumber}
                                ${statusBadge}
                                ${infoButton}
                            </div>
                            <div class="season-details" style="font-size: 0.85em; color: #aaa; margin-top: 3px;">
                                üìÑ ${totalFiles} files | Last checked: ${lastChecked}
                            </div>
                        </div>
                        <div class="season-actions">
                            <button onclick="console.log('Season button clicked:', ${seriesId}, ${season.seasonNumber}); verifySeason(${seriesId}, ${season.seasonNumber})" class="secondary">
                                ‚úì Verify
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Verify entire series
        async function verifySeries(seriesId) {
            console.log('verifySeries called with ID:', seriesId);
            const series = shows.find(s => s.id === seriesId);
            if (!series) {
                console.error('Series not found:', seriesId);
                return;
            }
            
            console.log('Found series:', series.title);
            if (!confirm(`Start verification for "${series.title}"?\n\nThis will check all episodes in all seasons.`)) {
                console.log('User cancelled verification');
                return;
            }
            
            console.log('Starting verification for series:', seriesId);
            try {
                const response = await fetch(`/api/shows/${seriesId}/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                console.log('Verification response:', response.status);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to start verification');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Verify specific season
        async function verifySeason(seriesId, seasonNumber) {
            console.log('verifySeason called:', seriesId, seasonNumber);
            const series = shows.find(s => s.id === seriesId);
            if (!series) {
                console.error('Series not found:', seriesId);
                return;
            }
            
            console.log('Found series:', series.title);
            if (!confirm(`Start verification for "${series.title}" Season ${seasonNumber}?`)) {
                console.log('User cancelled season verification');
                return;
            }
            
            console.log('Starting season verification:', seriesId, seasonNumber);
            try {
                const response = await fetch(`/api/shows/${seriesId}/seasons/${seasonNumber}/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                console.log('Season verification response:', response.status);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to start verification');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Stop verification
        async function stopVerification() {
            if (!confirm('Stop the current verification?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/verification/stop', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to stop verification');
                }
                
                alert('‚úÖ Verification stopped');
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Show broken files alert
        async function showBrokenFiles(seriesId, seasonNumber) {
            try {
                const response = await fetch(`/api/shows/${seriesId}/seasons`);
                const seasons = await response.json();
                const season = seasons.find(s => s.seasonNumber === seasonNumber);
                
                if (!season || !season.verification_data) return;
                
                const brokenFiles = season.verification_data.broken_files || [];
                if (brokenFiles.length === 0) {
                    alert('No broken files found');
                    return;
                }
                
                const fileList = brokenFiles.map(f => {
                    const fileName = f.relativePath || f.path || 'Unknown file';
                    // Extract episode number from filename if not in metadata
                    let episodeInfo = '';
                    if (f.episodeNumbers && f.episodeNumbers.length > 0) {
                        episodeInfo = `Episode ${f.episodeNumbers.join(', ')}`;
                    } else {
                        // Try to extract from filename (e.g., S03E13)
                        const match = fileName.match(/S(\d+)E(\d+)/i);
                        if (match) {
                            episodeInfo = `Episode ${parseInt(match[2])}`;
                        } else {
                            episodeInfo = 'Episode ?';
                        }
                    }
                    return `${episodeInfo}\n  ${fileName}`;
                }).join('\n\n');
                
                alert(`Broken files in Season ${seasonNumber}:\n\n${fileList}`);
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Refresh verification status
        async function refreshVerificationStatus() {
            try {
                const response = await fetch('/api/verification/status');
                verificationStatus = await response.json();
                renderVerificationProgress();
            } catch (error) {
                console.error('Error refreshing verification status:', error);
            }
        }

        // Render verification progress
        function renderVerificationProgress() {
            const container = document.getElementById('verification-progress-container');
            
            if (!verificationStatus || !verificationStatus.is_active) {
                container.innerHTML = '';
                return;
            }
            
            const progress = verificationStatus.current_index / verificationStatus.total_files * 100;
            const remainingTime = verificationStatus.estimated_remaining;
            const remainingMinutes = Math.ceil(remainingTime / 60);
            
            container.innerHTML = `
                <div class="verification-progress">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-weight: bold;">‚è≥ Verification in Progress</div>
                        <button onclick="stopVerification()" class="danger" style="width: auto; padding: 5px 15px; margin: 0;">
                            ‚èπ Stop
                        </button>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div style="font-size: 0.9em; color: #aaa;">
                        <div>üìÑ ${verificationStatus.current_index} / ${verificationStatus.total_files} files checked</div>
                        <div>‚è± Last file: ${verificationStatus.last_duration.toFixed(1)}s | Estimated remaining: ~${remainingMinutes} min</div>
                        <div style="font-size: 0.85em; margin-top: 5px;">Current: ${verificationStatus.current_file || 'Starting...'}</div>
                    </div>
                </div>
            `;
        }

        // DTS CONVERTER TAB FUNCTIONS
        // ============================================================================

        // Refresh DTS movies list
        async function refreshDTSMovies() {
            const container = document.getElementById('dts-movies-container');
            container.innerHTML = '<div class="loading">Loading DTS movies...</div>';
            
            try {
                const response = await fetch('/api/movies/dts');
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to load DTS movies');
                }
                
                dtsMovies = await response.json();
                renderDTSMovies();
            } catch (error) {
                container.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Render DTS movies list
        function renderDTSMovies() {
            const container = document.getElementById('dts-movies-container');
            
            if (dtsMovies.length === 0) {
                container.innerHTML = '<div class="empty-state">No movies with DTS audio found</div>';
                return;
            }
            
            container.innerHTML = dtsMovies.map(movie => {
                const movieFile = movie.movieFile || {};
                const size = movieFile.size ? (movieFile.size / 1024 / 1024 / 1024).toFixed(2) + ' GB' : 'Unknown';
                const quality = movieFile.quality?.quality?.name || 'Unknown';
                const relativePath = movieFile.relativePath || '';
                
                const inQueue = queue.some(item => item.movie.id === movie.id);
                
                return `
                    <div class="movie-item">
                        <div class="movie-info">
                            <div class="movie-title">${movie.title} (${movie.year})</div>
                            <div class="movie-details">
                                üì¶ ${size} | üé• ${quality}
                            </div>
                            <div class="movie-details" style="font-size: 0.75em; color: #888; margin-top: 3px;">
                                ${relativePath}
                            </div>
                        </div>
                        <div class="movie-actions">
                            <button 
                                onclick="addToQueue(${movie.id}, 'convert')" 
                                ${inQueue ? 'disabled' : ''}
                                class="warning"
                            >
                                ${inQueue ? '‚úì In Queue' : 'üéµ Convert to FLAC'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================================================
        // UNIFIED QUEUE FUNCTIONS
        // ============================================================================

        // Add movie to unified queue
        async function addToQueue(movieId, operationType) {
            const movieList = operationType === 'copy' ? movies : dtsMovies;
            const movie = movieList.find(m => m.id === movieId);
            if (!movie) return;
            
            try {
                // For convert operation, show audio info confirmation
                if (operationType === 'convert') {
                    // Get audio info first
                    const audioResponse = await fetch(`/api/movies/${movieId}/audio-info`);
                    if (!audioResponse.ok) {
                        const error = await audioResponse.json();
                        throw new Error(error.error || 'Failed to get audio info');
                    }
                    
                    const audioInfo = await audioResponse.json();
                    
                    // Show confirmation with audio details
                    const confirmMessage = `Convert "${movie.title}" to FLAC 7.1?\n\n` +
                        `Current Audio:\n` +
                        `Codec: ${audioInfo.codec_long_name || audioInfo.codec_name}\n` +
                        `Channels: ${audioInfo.channel_layout} (${audioInfo.channels} channels)\n` +
                        `Sample Rate: ${audioInfo.sample_rate} Hz\n` +
                        `Bit Rate: ${audioInfo.bit_rate ? (parseInt(audioInfo.bit_rate) / 1000).toFixed(0) + ' kbps' : 'Unknown'}\n\n` +
                        `This will convert to FLAC 7.1 and replace the original file.`;
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                }
                
                const response = await fetch('/api/queue/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        movie: movie,
                        operation_type: operationType
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add to queue');
                }
                
                await refreshQueue();
                if (operationType === 'copy') {
                    renderMovies();
                } else {
                    renderDTSMovies();
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Refresh unified queue
        async function refreshQueue() {
            try {
                const response = await fetch('/api/queue');
                queue = await response.json();
                renderQueue();
            } catch (error) {
                console.error('Error refreshing queue:', error);
            }
        }

        // Render unified queue
        function renderQueue() {
            const container = document.getElementById('queue-container');
            
            if (queue.length === 0) {
                container.innerHTML = '<div class="empty-state">No items in queue</div>';
                return;
            }
            
            container.innerHTML = queue.map(item => {
                const movie = item.movie;
                const movieFile = movie.movieFile || {};
                const size = movieFile.size ? (movieFile.size / 1024 / 1024 / 1024).toFixed(2) + ' GB' : 'Unknown';
                const operationType = item.operation_type || 'unknown';
                const operationLabel = operationType === 'copy' ? 'Copy' : operationType === 'convert' ? 'Convert' : operationType;
                
                return `
                    <div class="queue-item">
                        <div class="queue-info">
                            <div class="queue-title">
                                ${movie.title} (${movie.year})
                                <span class="operation-badge ${operationType}">${operationLabel}</span>
                            </div>
                            <div class="queue-details">üì¶ ${size}</div>
                            <div class="status ${item.status}">${item.status.toUpperCase()}</div>
                            <div class="progress-text">${item.progress}</div>
                        </div>
                        <div class="queue-actions">
                            ${item.status === 'pending' ? `
                                <button onclick="removeFromQueue('${item.id}')" class="danger">
                                    üóëÔ∏è Remove
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Remove from unified queue
        async function removeFromQueue(itemId) {
            try {
                const response = await fetch(`/api/queue/${itemId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to remove from queue');
                }
                
                await refreshQueue();
                renderMovies();
                renderDTSMovies();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Force clear unified queue
        async function clearQueue() {
            if (!confirm('‚ö†Ô∏è WARNING: This will forcefully clear ALL items from the unified queue, including any currently processing items.\n\nThis action cannot be undone!\n\nAre you sure?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/queue/clear', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to clear queue');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                await refreshQueue();
                renderMovies();
                renderDTSMovies();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Refresh unified history
        async function refreshHistory() {
            try {
                const response = await fetch('/api/history');
                history = await response.json();
                renderHistory();
            } catch (error) {
                console.error('Error refreshing history:', error);
            }
        }

        // Render unified history
        function renderHistory() {
            const container = document.getElementById('history-container');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="empty-state">No operations yet</div>';
                return;
            }
            
            container.innerHTML = history.map(item => {
                const icon = item.success ? '‚úÖ' : '‚ùå';
                const statusClass = item.success ? 'completed' : 'failed';
                const statusText = item.success ? 'Success' : 'Failed';
                const errorText = item.error ? ` - ${item.error}` : '';
                const operationType = item.operation_type || 'unknown';
                const operationLabel = operationType === 'copy' ? 'Copy' : operationType === 'convert' ? 'Convert' : operationType;
                
                // Show "Try Again" button only for failed convert operations
                const retryButton = !item.success && operationType === 'convert' && item.movie_path ? `
                    <button
                        onclick="retryConversion('${item.movie_path.replace(/'/g, "\\'")}', '${item.movie_title.replace(/'/g, "\\'")}')"
                        class="warning"
                        style="padding: 5px 10px; font-size: 0.85em; margin-top: 5px;"
                    >
                        üîÑ Try Again
                    </button>
                ` : '';
                
                return `
                    <div class="movie-item" style="padding: 8px 12px;">
                        <div class="movie-info" style="display: flex; align-items: center; gap: 10px; width: 100%;">
                            <span style="font-size: 1.2em;">${icon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 0.95em;">
                                    ${item.movie_title}
                                    <span class="operation-badge ${operationType}">${operationLabel}</span>
                                </div>
                                <div style="font-size: 0.8em; color: #aaa;">
                                    <span class="status ${statusClass}" style="padding: 2px 6px; font-size: 0.75em;">${statusText}</span>
                                    ${errorText}
                                </div>
                                ${retryButton}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Retry failed conversion
        async function retryConversion(moviePath, movieTitle) {
            if (!confirm(`Retry conversion for "${movieTitle}"?\n\nThis will re-analyze the file and attempt conversion again.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/convert/retry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ movie_path: moviePath })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to retry conversion');
                }
                
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                await refreshQueue();
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // ============================================================================
        // SETTINGS TAB FUNCTIONS
        // ============================================================================

        // Load configuration on page load
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                document.getElementById('radarr_host').value = config.radarr_host || '';
                document.getElementById('radarr_port').value = config.radarr_port || '';
                document.getElementById('radarr_api_key').value = config.radarr_api_key || '';
                document.getElementById('sonarr_host').value = config.sonarr_host || '';
                document.getElementById('sonarr_port').value = config.sonarr_port || '';
                document.getElementById('sonarr_api_key').value = config.sonarr_api_key || '';
                
                // Display root folders if they exist
                if (config.ssd_root_folder) {
                    document.getElementById('ssd_root_folder').value = config.ssd_root_folder;
                    document.getElementById('ssd-folder-group').style.display = 'flex';
                }
                if (config.hdd_root_folder) {
                    document.getElementById('hdd_root_folder').value = config.hdd_root_folder;
                    document.getElementById('hdd-folder-group').style.display = 'flex';
                }
                if (config.shows_hdd_root_folder) {
                    document.getElementById('shows_hdd_root_folder').value = config.shows_hdd_root_folder;
                    document.getElementById('shows-hdd-folder-group').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Save settings
        async function saveSettings(event) {
            event.preventDefault();
            
            const messageDiv = document.getElementById('settings-message');
            messageDiv.innerHTML = '';
            
            const config = {
                radarr_host: document.getElementById('radarr_host').value,
                radarr_port: document.getElementById('radarr_port').value,
                radarr_api_key: document.getElementById('radarr_api_key').value,
                sonarr_host: document.getElementById('sonarr_host').value,
                sonarr_port: document.getElementById('sonarr_port').value,
                sonarr_api_key: document.getElementById('sonarr_api_key').value
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Display detected root folders
                    if (result.ssd_root_folder) {
                        document.getElementById('ssd_root_folder').value = result.ssd_root_folder;
                        document.getElementById('ssd-folder-group').style.display = 'flex';
                    }
                    if (result.hdd_root_folder) {
                        document.getElementById('hdd_root_folder').value = result.hdd_root_folder;
                        document.getElementById('hdd-folder-group').style.display = 'flex';
                    }
                    if (result.shows_hdd_root_folder) {
                        document.getElementById('shows_hdd_root_folder').value = result.shows_hdd_root_folder;
                        document.getElementById('shows-hdd-folder-group').style.display = 'flex';
                    }
                    
                    messageDiv.innerHTML = '<div class="success">‚úÖ Settings saved successfully! Root folders auto-detected.</div>';
                    await loadConfig();
                } else {
                    messageDiv.innerHTML = `<div class="error">‚ùå Error: ${result.error}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // ============================================================================
        // AUTO-REFRESH AND INITIALIZATION
        // ============================================================================

        // Auto-refresh queue, history, and verification status every 2 seconds
        setInterval(() => {
            refreshQueue();
            refreshHistory();
            refreshVerificationStatus();
        }, 2000);

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadConfig();
            await refreshQueue();
            await refreshHistory();
        });
    </script>
</body>
</html>